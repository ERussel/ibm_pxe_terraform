---
  - hosts: vm_instances
    become: true
    tasks:
      - name: Update apt packages
        apt: upgrade=yes update_cache=yes
        when: ansible_facts['os_family'] == "Debian"
      - name: "Install PXE TFTP utilities"
        apt:
          name: "{{ packages }}"
        vars:
          packages:
          - apache2
          - tftpd-hpa
          - inetutils-inetd
      - name: "Update the tftp configuration"
        blockinfile:
          path: /etc/default/tftpd-hpa
          block: |
            RUN_DAEMON="yes"
            OPTIONS="-l -s /var/lib/tftpboot"
      - name: "Update inetd.conf"
        blockinfile:
          path: /etc/inetd.conf
          block: |
            tftp    dgram   udp    wait    root    /usr/sbin/in.tftpd /usr/sbin/in.tftpd -s /var/lib/tftpboot
      - name: "Start/restart services"
        systemd:
          state: restarted
          name: tftpd-hpa
      - name: "Create directory for downloaded ISOs"
        file:
          path: /mnt/iso-storage
          state: directory
          mode: '0755'
      - name: "Grab Ubuntu ISO for testing PXE boot"
        get_url:
          url: http://releases.ubuntu.com/16.04/ubuntu-16.04.6-server-amd64.iso
          dest: /tmp/ubuntu-16.04.6-server-amd64.iso
          mode: '0644'
        register: get_ubuntu_iso
      - debug: 
          msg="ISO already downloaded"
        when: get_ubuntu_iso|changed
      - name: Mount Ubuntu server ISO read-only
        mount: 
          path: /mnt/iso-storage
          src: /tmp/ubuntu-16.04.6-server-amd64.iso
          fstype: iso9660
          opts: ro,loop
          state: mounted
      - name: Synchronize two directories on one remote host.
        synchronize:
          src: /mnt/iso-storage/install/netboot/
          dest: /var/lib/tftpboot/
        delegate_to: "{{ inventory_hostname }}"
      # - name: "Copy Ubuntu ISO install files to TFTP directory"
      #   copy:
      #     src: /mnt/iso-storage/install/netboot/
      #     dest: /var/lib/tftpboot/
      #     remote_src: yes